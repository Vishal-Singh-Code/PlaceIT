{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/validation/testSchemas.ts"],"sourcesContent":["import { z } from \"zod\";\r\n\r\nexport const startTestSchema = z.object({\r\n  testTemplateId: z.string().min(1),\r\n  userId: z.string().min(1)\r\n});\r\n\r\nexport const submitAnswerSchema = z.object({\r\n  attemptId: z.string().min(1),\r\n  questionId: z.string().min(1),\r\n  sectionId: z.string().min(1),\r\n  selectedOptionIndex: z.number().int().nonnegative().nullable(),\r\n  timeSpentSeconds: z.number().int().nonnegative()\r\n});\r\n\r\nexport const finalSubmitSchema = z.object({\r\n  attemptId: z.string().min(1),\r\n  mode: z.enum([\"manual\", \"auto\"]).default(\"manual\")\r\n});\r\n\r\nexport type StartTestInput = z.infer<typeof startTestSchema>;\r\nexport type SubmitAnswerInput = z.infer<typeof submitAnswerSchema>;\r\nexport type FinalSubmitInput = z.infer<typeof finalSubmitSchema>;\r\n\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEO,MAAM,kBAAkB,uKAAC,CAAC,MAAM,CAAC;IACtC,gBAAgB,uKAAC,CAAC,MAAM,GAAG,GAAG,CAAC;IAC/B,QAAQ,uKAAC,CAAC,MAAM,GAAG,GAAG,CAAC;AACzB;AAEO,MAAM,qBAAqB,uKAAC,CAAC,MAAM,CAAC;IACzC,WAAW,uKAAC,CAAC,MAAM,GAAG,GAAG,CAAC;IAC1B,YAAY,uKAAC,CAAC,MAAM,GAAG,GAAG,CAAC;IAC3B,WAAW,uKAAC,CAAC,MAAM,GAAG,GAAG,CAAC;IAC1B,qBAAqB,uKAAC,CAAC,MAAM,GAAG,GAAG,GAAG,WAAW,GAAG,QAAQ;IAC5D,kBAAkB,uKAAC,CAAC,MAAM,GAAG,GAAG,GAAG,WAAW;AAChD;AAEO,MAAM,oBAAoB,uKAAC,CAAC,MAAM,CAAC;IACxC,WAAW,uKAAC,CAAC,MAAM,GAAG,GAAG,CAAC;IAC1B,MAAM,uKAAC,CAAC,IAAI,CAAC;QAAC;QAAU;KAAO,EAAE,OAAO,CAAC;AAC3C"}},
    {"offset": {"line": 36, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/db/connection.ts"],"sourcesContent":["import mongoose from \"mongoose\";\r\n\r\nconst MONGODB_URI = process.env.MONGODB_URI;\r\n\r\nif (!MONGODB_URI) {\r\n  throw new Error(\"MONGODB_URI is not set in the environment\");\r\n}\r\n\r\ninterface GlobalMongoose {\r\n  conn: typeof mongoose | null;\r\n  promise: Promise<typeof mongoose> | null;\r\n}\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line no-var\r\n  var _mongoose: GlobalMongoose | undefined;\r\n}\r\n\r\nlet cached = global._mongoose;\r\n\r\nif (!cached) {\r\n  cached = global._mongoose = { conn: null, promise: null };\r\n}\r\n\r\nexport async function connectToDatabase() {\r\n  if (cached!.conn) {\r\n    return cached!.conn;\r\n  }\r\n\r\n  if (!cached!.promise) {\r\n    cached!.promise = mongoose.connect(MONGODB_URI as string, {\r\n      dbName: \"placeit\"\r\n    });\r\n  }\r\n\r\n  cached!.conn = await cached!.promise;\r\n  return cached!.conn;\r\n}\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW;AAE3C,IAAI,CAAC,aAAa;IAChB,MAAM,IAAI,MAAM;AAClB;AAYA,IAAI,SAAS,OAAO,SAAS;AAE7B,IAAI,CAAC,QAAQ;IACX,SAAS,OAAO,SAAS,GAAG;QAAE,MAAM;QAAM,SAAS;IAAK;AAC1D;AAEO,eAAe;IACpB,IAAI,OAAQ,IAAI,EAAE;QAChB,OAAO,OAAQ,IAAI;IACrB;IAEA,IAAI,CAAC,OAAQ,OAAO,EAAE;QACpB,OAAQ,OAAO,GAAG,mKAAQ,CAAC,OAAO,CAAC,aAAuB;YACxD,QAAQ;QACV;IACF;IAEA,OAAQ,IAAI,GAAG,MAAM,OAAQ,OAAO;IACpC,OAAO,OAAQ,IAAI;AACrB"}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/db/models/TestTemplate.ts"],"sourcesContent":["import { Schema, model, models, Document, Types } from \"mongoose\";\r\n\r\nexport interface SectionConfig {\r\n  sectionId: Types.ObjectId;\r\n  numberOfQuestions: number;\r\n  order: number;\r\n}\r\n\r\nexport interface TestTemplateDocument extends Document {\r\n  examId: Types.ObjectId;\r\n  name: string;\r\n  durationMinutes: number;\r\n  sectionConfig: SectionConfig[];\r\n  isActive: boolean;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nconst SectionConfigSchema = new Schema<SectionConfig>(\r\n  {\r\n    sectionId: { type: Schema.Types.ObjectId, ref: \"Section\", required: true },\r\n    numberOfQuestions: { type: Number, required: true },\r\n    order: { type: Number, required: true }\r\n  },\r\n  { _id: false }\r\n);\r\n\r\nconst TestTemplateSchema = new Schema<TestTemplateDocument>(\r\n  {\r\n    examId: { type: Schema.Types.ObjectId, ref: \"Exam\", required: true },\r\n    name: { type: String, required: true },\r\n    durationMinutes: { type: Number, required: true },\r\n    sectionConfig: { type: [SectionConfigSchema], required: true },\r\n    isActive: { type: Boolean, default: true }\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nTestTemplateSchema.index({ examId: 1, isActive: 1 });\r\n\r\nexport const TestTemplate =\r\n  (models.TestTemplate as ReturnType<typeof model<TestTemplateDocument>>) ||\r\n  model<TestTemplateDocument>(\"TestTemplate\", TestTemplateSchema);\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAkBA,MAAM,sBAAsB,IAAI,kKAAM,CACpC;IACE,WAAW;QAAE,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAW,UAAU;IAAK;IACzE,mBAAmB;QAAE,MAAM;QAAQ,UAAU;IAAK;IAClD,OAAO;QAAE,MAAM;QAAQ,UAAU;IAAK;AACxC,GACA;IAAE,KAAK;AAAM;AAGf,MAAM,qBAAqB,IAAI,kKAAM,CACnC;IACE,QAAQ;QAAE,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAQ,UAAU;IAAK;IACnE,MAAM;QAAE,MAAM;QAAQ,UAAU;IAAK;IACrC,iBAAiB;QAAE,MAAM;QAAQ,UAAU;IAAK;IAChD,eAAe;QAAE,MAAM;YAAC;SAAoB;QAAE,UAAU;IAAK;IAC7D,UAAU;QAAE,MAAM;QAAS,SAAS;IAAK;AAC3C,GACA;IAAE,YAAY;AAAK;AAGrB,mBAAmB,KAAK,CAAC;IAAE,QAAQ;IAAG,UAAU;AAAE;AAE3C,MAAM,eACX,AAAC,kKAAM,CAAC,YAAY,IACpB,IAAA,iKAAK,EAAuB,gBAAgB"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/db/models/TestAttempt.ts"],"sourcesContent":["import { Schema, model, models, Document, Types } from \"mongoose\";\r\n\r\nexport type AttemptStatus = \"in_progress\" | \"submitted\" | \"auto_submitted\";\r\n\r\nexport interface TestAttemptDocument extends Document {\r\n  testTemplateId: Types.ObjectId;\r\n  userId: string;\r\n  startedAt: Date;\r\n  submittedAt?: Date;\r\n  durationSeconds?: number;\r\n  status: AttemptStatus;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nconst TestAttemptSchema = new Schema<TestAttemptDocument>(\r\n  {\r\n    testTemplateId: {\r\n      type: Schema.Types.ObjectId,\r\n      ref: \"TestTemplate\",\r\n      required: true\r\n    },\r\n    userId: { type: String, required: true },\r\n    startedAt: { type: Date, required: true },\r\n    submittedAt: Date,\r\n    durationSeconds: Number,\r\n    status: {\r\n      type: String,\r\n      enum: [\"in_progress\", \"submitted\", \"auto_submitted\"],\r\n      default: \"in_progress\"\r\n    }\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nTestAttemptSchema.index({ testTemplateId: 1, userId: 1, status: 1 });\r\n\r\nexport const TestAttempt =\r\n  (models.TestAttempt as ReturnType<typeof model<TestAttemptDocument>>) ||\r\n  model<TestAttemptDocument>(\"TestAttempt\", TestAttemptSchema);\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAeA,MAAM,oBAAoB,IAAI,kKAAM,CAClC;IACE,gBAAgB;QACd,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,UAAU;IACZ;IACA,QAAQ;QAAE,MAAM;QAAQ,UAAU;IAAK;IACvC,WAAW;QAAE,MAAM;QAAM,UAAU;IAAK;IACxC,aAAa;IACb,iBAAiB;IACjB,QAAQ;QACN,MAAM;QACN,MAAM;YAAC;YAAe;YAAa;SAAiB;QACpD,SAAS;IACX;AACF,GACA;IAAE,YAAY;AAAK;AAGrB,kBAAkB,KAAK,CAAC;IAAE,gBAAgB;IAAG,QAAQ;IAAG,QAAQ;AAAE;AAE3D,MAAM,cACX,AAAC,kKAAM,CAAC,WAAW,IACnB,IAAA,iKAAK,EAAsB,eAAe"}},
    {"offset": {"line": 172, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/db/models/Question.ts"],"sourcesContent":["import { Schema, model, models, Document, Types } from \"mongoose\";\r\n\r\nexport interface QuestionOption {\r\n  label: string;\r\n  value: string;\r\n}\r\n\r\nexport interface QuestionDocument extends Document {\r\n  examId: Types.ObjectId;\r\n  sectionId: Types.ObjectId;\r\n  text: string;\r\n  options: QuestionOption[];\r\n  correctOptionIndex: number;\r\n  difficulty?: \"easy\" | \"medium\" | \"hard\";\r\n  tags?: string[];\r\n  explanation?: string;\r\n  sourceYear?: number;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nconst QuestionSchema = new Schema<QuestionDocument>(\r\n  {\r\n    examId: { type: Schema.Types.ObjectId, ref: \"Exam\", required: true },\r\n    sectionId: { type: Schema.Types.ObjectId, ref: \"Section\", required: true },\r\n    text: { type: String, required: true },\r\n    options: [\r\n      {\r\n        label: { type: String, required: true },\r\n        value: { type: String, required: true }\r\n      }\r\n    ],\r\n    correctOptionIndex: { type: Number, required: true },\r\n    difficulty: {\r\n      type: String,\r\n      enum: [\"easy\", \"medium\", \"hard\"],\r\n      default: \"medium\"\r\n    },\r\n    tags: [String],\r\n    explanation: String,\r\n    sourceYear: Number\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nQuestionSchema.index({ examId: 1, sectionId: 1 });\r\n\r\nexport const Question =\r\n  (models.Question as ReturnType<typeof model<QuestionDocument>>) ||\r\n  model<QuestionDocument>(\"Question\", QuestionSchema);\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAqBA,MAAM,iBAAiB,IAAI,kKAAM,CAC/B;IACE,QAAQ;QAAE,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAQ,UAAU;IAAK;IACnE,WAAW;QAAE,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAW,UAAU;IAAK;IACzE,MAAM;QAAE,MAAM;QAAQ,UAAU;IAAK;IACrC,SAAS;QACP;YACE,OAAO;gBAAE,MAAM;gBAAQ,UAAU;YAAK;YACtC,OAAO;gBAAE,MAAM;gBAAQ,UAAU;YAAK;QACxC;KACD;IACD,oBAAoB;QAAE,MAAM;QAAQ,UAAU;IAAK;IACnD,YAAY;QACV,MAAM;QACN,MAAM;YAAC;YAAQ;YAAU;SAAO;QAChC,SAAS;IACX;IACA,MAAM;QAAC;KAAO;IACd,aAAa;IACb,YAAY;AACd,GACA;IAAE,YAAY;AAAK;AAGrB,eAAe,KAAK,CAAC;IAAE,QAAQ;IAAG,WAAW;AAAE;AAExC,MAAM,WACX,AAAC,kKAAM,CAAC,QAAQ,IAChB,IAAA,iKAAK,EAAmB,YAAY"}},
    {"offset": {"line": 235, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/db/models/QuestionResponse.ts"],"sourcesContent":["import { Schema, model, models, Document, Types } from \"mongoose\";\r\n\r\nexport interface QuestionResponseDocument extends Document {\r\n  attemptId: Types.ObjectId;\r\n  questionId: Types.ObjectId;\r\n  sectionId: Types.ObjectId;\r\n  selectedOptionIndex: number | null;\r\n  isCorrect: boolean | null;\r\n  timeSpentSeconds: number;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nconst QuestionResponseSchema = new Schema<QuestionResponseDocument>(\r\n  {\r\n    attemptId: {\r\n      type: Schema.Types.ObjectId,\r\n      ref: \"TestAttempt\",\r\n      required: true\r\n    },\r\n    questionId: {\r\n      type: Schema.Types.ObjectId,\r\n      ref: \"Question\",\r\n      required: true\r\n    },\r\n    sectionId: {\r\n      type: Schema.Types.ObjectId,\r\n      ref: \"Section\",\r\n      required: true\r\n    },\r\n    selectedOptionIndex: { type: Number, default: null },\r\n    isCorrect: { type: Boolean, default: null },\r\n    timeSpentSeconds: { type: Number, default: 0 }\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nQuestionResponseSchema.index({ attemptId: 1 });\r\nQuestionResponseSchema.index({ attemptId: 1, questionId: 1 }, { unique: true });\r\n\r\nexport const QuestionResponse =\r\n  (models.QuestionResponse as ReturnType<\r\n    typeof model<QuestionResponseDocument>\r\n  >) || model<QuestionResponseDocument>(\"QuestionResponse\", QuestionResponseSchema);\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAaA,MAAM,yBAAyB,IAAI,kKAAM,CACvC;IACE,WAAW;QACT,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,UAAU;IACZ;IACA,YAAY;QACV,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,UAAU;IACZ;IACA,WAAW;QACT,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,UAAU;IACZ;IACA,qBAAqB;QAAE,MAAM;QAAQ,SAAS;IAAK;IACnD,WAAW;QAAE,MAAM;QAAS,SAAS;IAAK;IAC1C,kBAAkB;QAAE,MAAM;QAAQ,SAAS;IAAE;AAC/C,GACA;IAAE,YAAY;AAAK;AAGrB,uBAAuB,KAAK,CAAC;IAAE,WAAW;AAAE;AAC5C,uBAAuB,KAAK,CAAC;IAAE,WAAW;IAAG,YAAY;AAAE,GAAG;IAAE,QAAQ;AAAK;AAEtE,MAAM,mBACX,AAAC,kKAAM,CAAC,gBAAgB,IAElB,IAAA,iKAAK,EAA2B,oBAAoB"}},
    {"offset": {"line": 286, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/db/models/Section.ts"],"sourcesContent":["import { Schema, model, models, Document, Types } from \"mongoose\";\r\n\r\nexport interface SectionDocument extends Document {\r\n  examId: Types.ObjectId;\r\n  name: string;\r\n  order: number;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nconst SectionSchema = new Schema<SectionDocument>(\r\n  {\r\n    examId: { type: Schema.Types.ObjectId, ref: \"Exam\", required: true },\r\n    name: { type: String, required: true },\r\n    order: { type: Number, required: true }\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nSectionSchema.index({ examId: 1, order: 1 });\r\n\r\nexport const Section =\r\n  (models.Section as ReturnType<typeof model<SectionDocument>>) ||\r\n  model<SectionDocument>(\"Section\", SectionSchema);\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAUA,MAAM,gBAAgB,IAAI,kKAAM,CAC9B;IACE,QAAQ;QAAE,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAQ,UAAU;IAAK;IACnE,MAAM;QAAE,MAAM;QAAQ,UAAU;IAAK;IACrC,OAAO;QAAE,MAAM;QAAQ,UAAU;IAAK;AACxC,GACA;IAAE,YAAY;AAAK;AAGrB,cAAc,KAAK,CAAC;IAAE,QAAQ;IAAG,OAAO;AAAE;AAEnC,MAAM,UACX,AAAC,kKAAM,CAAC,OAAO,IACf,IAAA,iKAAK,EAAkB,WAAW"}},
    {"offset": {"line": 318, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/db/models/AttemptAnalytics.ts"],"sourcesContent":["import { Schema, model, models, Document, Types } from \"mongoose\";\r\n\r\nexport interface SectionStats {\r\n  sectionId: Types.ObjectId;\r\n  totalQuestions: number;\r\n  correct: number;\r\n  incorrect: number;\r\n  unattempted: number;\r\n  accuracy: number;\r\n  totalTimeSeconds: number;\r\n  avgTimePerQuestionSeconds: number;\r\n  strengthLabel?: string;\r\n}\r\n\r\nexport interface AttemptAnalyticsDocument extends Document {\r\n  attemptId: Types.ObjectId;\r\n  testTemplateId: Types.ObjectId;\r\n  userId: string;\r\n  overallScore: number;\r\n  totalQuestions: number;\r\n  totalCorrect: number;\r\n  totalIncorrect: number;\r\n  totalUnattempted: number;\r\n  accuracy: number;\r\n  sectionStats: SectionStats[];\r\n  percentile?: number;\r\n  rank?: number;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nconst SectionStatsSchema = new Schema<SectionStats>(\r\n  {\r\n    sectionId: { type: Schema.Types.ObjectId, ref: \"Section\", required: true },\r\n    totalQuestions: { type: Number, required: true },\r\n    correct: { type: Number, required: true },\r\n    incorrect: { type: Number, required: true },\r\n    unattempted: { type: Number, required: true },\r\n    accuracy: { type: Number, required: true },\r\n    totalTimeSeconds: { type: Number, required: true },\r\n    avgTimePerQuestionSeconds: { type: Number, required: true },\r\n    strengthLabel: String\r\n  },\r\n  { _id: false }\r\n);\r\n\r\nconst AttemptAnalyticsSchema = new Schema<AttemptAnalyticsDocument>(\r\n  {\r\n    attemptId: {\r\n      type: Schema.Types.ObjectId,\r\n      ref: \"TestAttempt\",\r\n      required: true,\r\n      unique: true\r\n    },\r\n    testTemplateId: {\r\n      type: Schema.Types.ObjectId,\r\n      ref: \"TestTemplate\",\r\n      required: true\r\n    },\r\n    userId: { type: String, required: true },\r\n    overallScore: { type: Number, required: true },\r\n    totalQuestions: { type: Number, required: true },\r\n    totalCorrect: { type: Number, required: true },\r\n    totalIncorrect: { type: Number, required: true },\r\n    totalUnattempted: { type: Number, required: true },\r\n    accuracy: { type: Number, required: true },\r\n    sectionStats: { type: [SectionStatsSchema], required: true },\r\n    percentile: Number,\r\n    rank: Number\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nAttemptAnalyticsSchema.index({ testTemplateId: 1, userId: 1 });\r\n\r\nexport const AttemptAnalytics =\r\n  (models.AttemptAnalytics as ReturnType<\r\n    typeof model<AttemptAnalyticsDocument>\r\n  >) ||\r\n  model<AttemptAnalyticsDocument>(\"AttemptAnalytics\", AttemptAnalyticsSchema);\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AA+BA,MAAM,qBAAqB,IAAI,kKAAM,CACnC;IACE,WAAW;QAAE,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAW,UAAU;IAAK;IACzE,gBAAgB;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC/C,SAAS;QAAE,MAAM;QAAQ,UAAU;IAAK;IACxC,WAAW;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC1C,aAAa;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC5C,UAAU;QAAE,MAAM;QAAQ,UAAU;IAAK;IACzC,kBAAkB;QAAE,MAAM;QAAQ,UAAU;IAAK;IACjD,2BAA2B;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC1D,eAAe;AACjB,GACA;IAAE,KAAK;AAAM;AAGf,MAAM,yBAAyB,IAAI,kKAAM,CACvC;IACE,WAAW;QACT,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,UAAU;QACV,QAAQ;IACV;IACA,gBAAgB;QACd,MAAM,kKAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,UAAU;IACZ;IACA,QAAQ;QAAE,MAAM;QAAQ,UAAU;IAAK;IACvC,cAAc;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC7C,gBAAgB;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC/C,cAAc;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC7C,gBAAgB;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC/C,kBAAkB;QAAE,MAAM;QAAQ,UAAU;IAAK;IACjD,UAAU;QAAE,MAAM;QAAQ,UAAU;IAAK;IACzC,cAAc;QAAE,MAAM;YAAC;SAAmB;QAAE,UAAU;IAAK;IAC3D,YAAY;IACZ,MAAM;AACR,GACA;IAAE,YAAY;AAAK;AAGrB,uBAAuB,KAAK,CAAC;IAAE,gBAAgB;IAAG,QAAQ;AAAE;AAErD,MAAM,mBACX,AAAC,kKAAM,CAAC,gBAAgB,IAGxB,IAAA,iKAAK,EAA2B,oBAAoB"}},
    {"offset": {"line": 422, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/services/analyticsService.ts"],"sourcesContent":["import { Types } from \"mongoose\";\r\nimport { AttemptAnalyticsCore, SectionAnalytics } from \"../types/analytics\";\r\nimport { Question, QuestionDocument } from \"../db/models/Question\";\r\nimport {\r\n  QuestionResponse,\r\n  QuestionResponseDocument\r\n} from \"../db/models/QuestionResponse\";\r\nimport { Section, SectionDocument } from \"../db/models/Section\";\r\nimport { TestAttempt } from \"../db/models/TestAttempt\";\r\nimport { AttemptAnalytics } from \"../db/models/AttemptAnalytics\";\r\nimport { connectToDatabase } from \"../db/connection\";\r\n\r\ninterface ComputeCoreInput {\r\n  attemptId: Types.ObjectId;\r\n  testTemplateId: Types.ObjectId;\r\n  userId: string;\r\n  questions: QuestionDocument[];\r\n  responses: QuestionResponseDocument[];\r\n  sections: SectionDocument[];\r\n}\r\n\r\nexport function computeAttemptAnalyticsCore(\r\n  input: ComputeCoreInput\r\n): AttemptAnalyticsCore {\r\n  const { attemptId, testTemplateId, userId, questions, responses, sections } =\r\n    input;\r\n\r\n  const responsesByQuestion = new Map<string, QuestionResponseDocument>();\r\n  for (const r of responses) {\r\n    responsesByQuestion.set(r.questionId.toString(), r);\r\n  }\r\n\r\n  const sectionStatsMap = new Map<string, SectionAnalytics>();\r\n\r\n  let totalCorrect = 0;\r\n  let totalIncorrect = 0;\r\n  let totalUnattempted = 0;\r\n  let totalQuestions = questions.length;\r\n\r\n  for (const question of questions) {\r\n    const key = question._id.toString();\r\n    const response = responsesByQuestion.get(key) || null;\r\n    const sectionId = question.sectionId.toString();\r\n\r\n    let sectionStats = sectionStatsMap.get(sectionId);\r\n    if (!sectionStats) {\r\n      sectionStats = {\r\n        sectionId: question.sectionId,\r\n        totalQuestions: 0,\r\n        correct: 0,\r\n        incorrect: 0,\r\n        unattempted: 0,\r\n        accuracy: 0,\r\n        totalTimeSeconds: 0,\r\n        avgTimePerQuestionSeconds: 0,\r\n        strengthLabel: undefined\r\n      };\r\n      sectionStatsMap.set(sectionId, sectionStats);\r\n    }\r\n\r\n    sectionStats.totalQuestions += 1;\r\n\r\n    const isAttempted =\r\n      response && response.selectedOptionIndex !== null ? true : false;\r\n    const isCorrect =\r\n      isAttempted &&\r\n      response!.selectedOptionIndex === question.correctOptionIndex;\r\n\r\n    if (!isAttempted) {\r\n      sectionStats.unattempted += 1;\r\n      totalUnattempted += 1;\r\n    } else if (isCorrect) {\r\n      sectionStats.correct += 1;\r\n      totalCorrect += 1;\r\n    } else {\r\n      sectionStats.incorrect += 1;\r\n      totalIncorrect += 1;\r\n    }\r\n\r\n    if (response) {\r\n      sectionStats.totalTimeSeconds += response.timeSpentSeconds;\r\n    }\r\n  }\r\n\r\n  for (const section of sectionStatsMap.values()) {\r\n    section.accuracy =\r\n      section.totalQuestions === 0\r\n        ? 0\r\n        : section.correct / section.totalQuestions;\r\n    section.avgTimePerQuestionSeconds =\r\n      section.totalQuestions === 0\r\n        ? 0\r\n        : section.totalTimeSeconds / section.totalQuestions;\r\n\r\n    if (section.accuracy >= 0.7) {\r\n      section.strengthLabel = \"Strong\";\r\n    } else if (section.accuracy >= 0.4) {\r\n      section.strengthLabel = \"Average\";\r\n    } else {\r\n      section.strengthLabel = \"Needs improvement\";\r\n    }\r\n  }\r\n\r\n  const accuracy = totalQuestions === 0 ? 0 : totalCorrect / totalQuestions;\r\n  const overallScore = totalCorrect;\r\n\r\n  return {\r\n    attemptId,\r\n    testTemplateId,\r\n    userId,\r\n    overallScore,\r\n    totalQuestions,\r\n    totalCorrect,\r\n    totalIncorrect,\r\n    totalUnattempted,\r\n    accuracy,\r\n    sectionStats: Array.from(sectionStatsMap.values())\r\n  };\r\n}\r\n\r\nexport async function computeAttemptAnalytics(attemptId: string) {\r\n  await connectToDatabase();\r\n\r\n  const attempt = await TestAttempt.findById(attemptId);\r\n  if (!attempt) {\r\n    throw new Error(\"Attempt not found\");\r\n  }\r\n\r\n  const [questions, responses, sections] = await Promise.all([\r\n    Question.find({}),\r\n    QuestionResponse.find({ attemptId: attempt._id }),\r\n    Section.find({})\r\n  ]);\r\n\r\n  const core = computeAttemptAnalyticsCore({\r\n    attemptId: attempt._id,\r\n    testTemplateId: attempt.testTemplateId,\r\n    userId: attempt.userId,\r\n    questions,\r\n    responses,\r\n    sections\r\n  });\r\n\r\n  const existing = await AttemptAnalytics.findOne({\r\n    attemptId: attempt._id\r\n  });\r\n\r\n  if (existing) {\r\n    existing.overallScore = core.overallScore;\r\n    existing.totalQuestions = core.totalQuestions;\r\n    existing.totalCorrect = core.totalCorrect;\r\n    existing.totalIncorrect = core.totalIncorrect;\r\n    existing.totalUnattempted = core.totalUnattempted;\r\n    existing.accuracy = core.accuracy;\r\n    existing.sectionStats = core.sectionStats;\r\n    await existing.save();\r\n    return existing;\r\n  }\r\n\r\n  const created = await AttemptAnalytics.create({\r\n    attemptId: core.attemptId,\r\n    testTemplateId: core.testTemplateId,\r\n    userId: core.userId,\r\n    overallScore: core.overallScore,\r\n    totalQuestions: core.totalQuestions,\r\n    totalCorrect: core.totalCorrect,\r\n    totalIncorrect: core.totalIncorrect,\r\n    totalUnattempted: core.totalUnattempted,\r\n    accuracy: core.accuracy,\r\n    sectionStats: core.sectionStats\r\n  });\r\n\r\n  return created;\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;AAEA;AACA;AAIA;AACA;AACA;AACA;;;;;;;AAWO,SAAS,4BACd,KAAuB;IAEvB,MAAM,EAAE,SAAS,EAAE,cAAc,EAAE,MAAM,EAAE,SAAS,EAAE,SAAS,EAAE,QAAQ,EAAE,GACzE;IAEF,MAAM,sBAAsB,IAAI;IAChC,KAAK,MAAM,KAAK,UAAW;QACzB,oBAAoB,GAAG,CAAC,EAAE,UAAU,CAAC,QAAQ,IAAI;IACnD;IAEA,MAAM,kBAAkB,IAAI;IAE5B,IAAI,eAAe;IACnB,IAAI,iBAAiB;IACrB,IAAI,mBAAmB;IACvB,IAAI,iBAAiB,UAAU,MAAM;IAErC,KAAK,MAAM,YAAY,UAAW;QAChC,MAAM,MAAM,SAAS,GAAG,CAAC,QAAQ;QACjC,MAAM,WAAW,oBAAoB,GAAG,CAAC,QAAQ;QACjD,MAAM,YAAY,SAAS,SAAS,CAAC,QAAQ;QAE7C,IAAI,eAAe,gBAAgB,GAAG,CAAC;QACvC,IAAI,CAAC,cAAc;YACjB,eAAe;gBACb,WAAW,SAAS,SAAS;gBAC7B,gBAAgB;gBAChB,SAAS;gBACT,WAAW;gBACX,aAAa;gBACb,UAAU;gBACV,kBAAkB;gBAClB,2BAA2B;gBAC3B,eAAe;YACjB;YACA,gBAAgB,GAAG,CAAC,WAAW;QACjC;QAEA,aAAa,cAAc,IAAI;QAE/B,MAAM,cACJ,YAAY,SAAS,mBAAmB,KAAK,OAAO,OAAO;QAC7D,MAAM,YACJ,eACA,SAAU,mBAAmB,KAAK,SAAS,kBAAkB;QAE/D,IAAI,CAAC,aAAa;YAChB,aAAa,WAAW,IAAI;YAC5B,oBAAoB;QACtB,OAAO,IAAI,WAAW;YACpB,aAAa,OAAO,IAAI;YACxB,gBAAgB;QAClB,OAAO;YACL,aAAa,SAAS,IAAI;YAC1B,kBAAkB;QACpB;QAEA,IAAI,UAAU;YACZ,aAAa,gBAAgB,IAAI,SAAS,gBAAgB;QAC5D;IACF;IAEA,KAAK,MAAM,WAAW,gBAAgB,MAAM,GAAI;QAC9C,QAAQ,QAAQ,GACd,QAAQ,cAAc,KAAK,IACvB,IACA,QAAQ,OAAO,GAAG,QAAQ,cAAc;QAC9C,QAAQ,yBAAyB,GAC/B,QAAQ,cAAc,KAAK,IACvB,IACA,QAAQ,gBAAgB,GAAG,QAAQ,cAAc;QAEvD,IAAI,QAAQ,QAAQ,IAAI,KAAK;YAC3B,QAAQ,aAAa,GAAG;QAC1B,OAAO,IAAI,QAAQ,QAAQ,IAAI,KAAK;YAClC,QAAQ,aAAa,GAAG;QAC1B,OAAO;YACL,QAAQ,aAAa,GAAG;QAC1B;IACF;IAEA,MAAM,WAAW,mBAAmB,IAAI,IAAI,eAAe;IAC3D,MAAM,eAAe;IAErB,OAAO;QACL;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA,cAAc,MAAM,IAAI,CAAC,gBAAgB,MAAM;IACjD;AACF;AAEO,eAAe,wBAAwB,SAAiB;IAC7D,MAAM,IAAA,4IAAiB;IAEvB,MAAM,UAAU,MAAM,iJAAW,CAAC,QAAQ,CAAC;IAC3C,IAAI,CAAC,SAAS;QACZ,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,CAAC,WAAW,WAAW,SAAS,GAAG,MAAM,QAAQ,GAAG,CAAC;QACzD,2IAAQ,CAAC,IAAI,CAAC,CAAC;QACf,2JAAgB,CAAC,IAAI,CAAC;YAAE,WAAW,QAAQ,GAAG;QAAC;QAC/C,yIAAO,CAAC,IAAI,CAAC,CAAC;KACf;IAED,MAAM,OAAO,4BAA4B;QACvC,WAAW,QAAQ,GAAG;QACtB,gBAAgB,QAAQ,cAAc;QACtC,QAAQ,QAAQ,MAAM;QACtB;QACA;QACA;IACF;IAEA,MAAM,WAAW,MAAM,2JAAgB,CAAC,OAAO,CAAC;QAC9C,WAAW,QAAQ,GAAG;IACxB;IAEA,IAAI,UAAU;QACZ,SAAS,YAAY,GAAG,KAAK,YAAY;QACzC,SAAS,cAAc,GAAG,KAAK,cAAc;QAC7C,SAAS,YAAY,GAAG,KAAK,YAAY;QACzC,SAAS,cAAc,GAAG,KAAK,cAAc;QAC7C,SAAS,gBAAgB,GAAG,KAAK,gBAAgB;QACjD,SAAS,QAAQ,GAAG,KAAK,QAAQ;QACjC,SAAS,YAAY,GAAG,KAAK,YAAY;QACzC,MAAM,SAAS,IAAI;QACnB,OAAO;IACT;IAEA,MAAM,UAAU,MAAM,2JAAgB,CAAC,MAAM,CAAC;QAC5C,WAAW,KAAK,SAAS;QACzB,gBAAgB,KAAK,cAAc;QACnC,QAAQ,KAAK,MAAM;QACnB,cAAc,KAAK,YAAY;QAC/B,gBAAgB,KAAK,cAAc;QACnC,cAAc,KAAK,YAAY;QAC/B,gBAAgB,KAAK,cAAc;QACnC,kBAAkB,KAAK,gBAAgB;QACvC,UAAU,KAAK,QAAQ;QACvB,cAAc,KAAK,YAAY;IACjC;IAEA,OAAO;AACT"}},
    {"offset": {"line": 566, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/services/rankingService.ts"],"sourcesContent":["import { connectToDatabase } from \"../db/connection\";\r\nimport { AttemptAnalytics } from \"../db/models/AttemptAnalytics\";\r\nimport { TestAttempt } from \"../db/models/TestAttempt\";\r\nimport { LeaderboardEntry } from \"../types/leaderboard\";\r\n\r\ninterface ScoreRecord {\r\n  attemptId: string;\r\n  score: number;\r\n  durationSeconds: number | null;\r\n}\r\n\r\nexport function computeRankAndPercentileCore(\r\n  scores: ScoreRecord[],\r\n  targetAttemptId: string\r\n) {\r\n  const sorted = [...scores].sort((a, b) => {\r\n    if (b.score !== a.score) {\r\n      return b.score - a.score;\r\n    }\r\n    const aDur = a.durationSeconds ?? Number.MAX_SAFE_INTEGER;\r\n    const bDur = b.durationSeconds ?? Number.MAX_SAFE_INTEGER;\r\n    return aDur - bDur;\r\n  });\r\n\r\n  const total = sorted.length;\r\n  const index = sorted.findIndex((s) => s.attemptId === targetAttemptId);\r\n  if (index === -1) {\r\n    throw new Error(\"Target attempt not found in scores array\");\r\n  }\r\n\r\n  const rank = index + 1;\r\n  const higherScoreCount = sorted.filter(\r\n    (s) => s.score > sorted[index].score\r\n  ).length;\r\n\r\n  /**\r\n   * Percentile formula:\r\n   * percentile = 100 * (1 - higherScoreCount / totalAttempts)\r\n   *\r\n   * Intuition:\r\n   * - if no one scored higher, percentile = 100\r\n   * - if everyone scored higher, percentile approaches 0\r\n   */\r\n  const percentile =\r\n    total === 0 ? 0 : 100 * (1 - higherScoreCount / total || 0);\r\n\r\n  return { rank, percentile };\r\n}\r\n\r\nexport async function computeRankAndPercentile(\r\n  testTemplateId: string,\r\n  attemptId: string\r\n) {\r\n  await connectToDatabase();\r\n\r\n  const [attempts, analytics] = await Promise.all([\r\n    TestAttempt.find({\r\n      testTemplateId,\r\n      status: { $in: [\"submitted\", \"auto_submitted\"] }\r\n    }).sort({ startedAt: 1 }),\r\n    AttemptAnalytics.find({ testTemplateId })\r\n  ]);\r\n\r\n  const analyticsByAttempt = new Map(\r\n    analytics.map((a) => [a.attemptId.toString(), a])\r\n  );\r\n\r\n  const scores: ScoreRecord[] = attempts.map((attempt) => {\r\n    const analyticsDoc = analyticsByAttempt.get(attempt._id.toString());\r\n    const score = analyticsDoc ? analyticsDoc.overallScore : 0;\r\n    const durationSeconds =\r\n      attempt.durationSeconds ??\r\n      (attempt.submittedAt && attempt.startedAt\r\n        ? Math.max(\r\n            0,\r\n            Math.round(\r\n              (attempt.submittedAt.getTime() - attempt.startedAt.getTime()) /\r\n                1000\r\n            )\r\n          )\r\n        : null);\r\n\r\n    return {\r\n      attemptId: attempt._id.toString(),\r\n      score,\r\n      durationSeconds\r\n    };\r\n  });\r\n\r\n  const { rank, percentile } = computeRankAndPercentileCore(scores, attemptId);\r\n\r\n  const analyticsForAttempt = await AttemptAnalytics.findOne({\r\n    attemptId\r\n  });\r\n  if (analyticsForAttempt) {\r\n    analyticsForAttempt.rank = rank;\r\n    analyticsForAttempt.percentile = percentile;\r\n    await analyticsForAttempt.save();\r\n  }\r\n\r\n  return { rank, percentile };\r\n}\r\n\r\nexport async function getLeaderboard(\r\n  testTemplateId: string,\r\n  limit = 10\r\n): Promise<LeaderboardEntry[]> {\r\n  await connectToDatabase();\r\n\r\n  const analytics = await AttemptAnalytics.find({ testTemplateId })\r\n    .sort({ overallScore: -1, createdAt: 1 })\r\n    .limit(limit);\r\n\r\n  const attempts = await TestAttempt.find({\r\n    _id: { $in: analytics.map((a) => a.attemptId) }\r\n  });\r\n  const attemptsById = new Map(\r\n    attempts.map((a) => [a._id.toString(), a])\r\n  );\r\n\r\n  const entries: LeaderboardEntry[] = analytics.map((a, idx) => {\r\n    const attempt = attemptsById.get(a.attemptId.toString());\r\n    return {\r\n      attemptId: a.attemptId.toString(),\r\n      userId: a.userId,\r\n      score: a.overallScore,\r\n      durationSeconds: attempt ? attempt.durationSeconds ?? null : null,\r\n      startedAt: attempt ? attempt.startedAt.toISOString() : \"\",\r\n      rank: idx + 1\r\n    };\r\n  });\r\n\r\n  return entries;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 691, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/services/testService.ts"],"sourcesContent":["import { Types } from \"mongoose\";\r\nimport { connectToDatabase } from \"../db/connection\";\r\nimport { TestTemplate } from \"../db/models/TestTemplate\";\r\nimport { TestAttempt } from \"../db/models/TestAttempt\";\r\nimport { Question } from \"../db/models/Question\";\r\nimport { QuestionResponse } from \"../db/models/QuestionResponse\";\r\nimport { computeAttemptAnalytics } from \"./analyticsService\";\r\nimport { computeRankAndPercentile } from \"./rankingService\";\r\nimport {\r\n  FinalSubmitInput,\r\n  StartTestInput,\r\n  SubmitAnswerInput\r\n} from \"../validation/testSchemas\";\r\n\r\nexport async function startAttempt(input: StartTestInput) {\r\n  await connectToDatabase();\r\n\r\n  const { testTemplateId, userId } = input;\r\n  const template = await TestTemplate.findById(testTemplateId);\r\n  if (!template) {\r\n    throw new Error(\"Test template not found\");\r\n  }\r\n\r\n  const questionSelections: { questionId: Types.ObjectId; sectionId: Types.ObjectId }[] =\r\n    [];\r\n\r\n  for (const cfg of template.sectionConfig.sort((a, b) => a.order - b.order)) {\r\n    const questions = await Question.find({\r\n      examId: template.examId,\r\n      sectionId: cfg.sectionId\r\n    })\r\n      .sort({ _id: 1 })\r\n      .limit(cfg.numberOfQuestions);\r\n\r\n    for (const q of questions) {\r\n      questionSelections.push({ questionId: q._id, sectionId: cfg.sectionId });\r\n    }\r\n  }\r\n\r\n  const now = new Date();\r\n\r\n  const attempt = await TestAttempt.create({\r\n    testTemplateId: template._id,\r\n    userId,\r\n    startedAt: now,\r\n    status: \"in_progress\"\r\n  });\r\n\r\n  await QuestionResponse.insertMany(\r\n    questionSelections.map((item) => ({\r\n      attemptId: attempt._id,\r\n      questionId: item.questionId,\r\n      sectionId: item.sectionId,\r\n      selectedOptionIndex: null,\r\n      isCorrect: null,\r\n      timeSpentSeconds: 0\r\n    }))\r\n  );\r\n\r\n  const populatedResponses = await QuestionResponse.find({\r\n    attemptId: attempt._id\r\n  });\r\n\r\n  return { attempt, responses: populatedResponses, template };\r\n}\r\n\r\nexport async function recordAnswer(input: SubmitAnswerInput) {\r\n  await connectToDatabase();\r\n\r\n  const { attemptId, questionId, sectionId, selectedOptionIndex, timeSpentSeconds } =\r\n    input;\r\n\r\n  const attempt = await TestAttempt.findById(attemptId);\r\n  if (!attempt) {\r\n    throw new Error(\"Attempt not found\");\r\n  }\r\n  if (attempt.status !== \"in_progress\") {\r\n    throw new Error(\"Attempt is not in progress\");\r\n  }\r\n\r\n  const question = await Question.findById(questionId);\r\n  if (!question) {\r\n    throw new Error(\"Question not found\");\r\n  }\r\n\r\n  const isCorrect =\r\n    selectedOptionIndex === null\r\n      ? null\r\n      : selectedOptionIndex === question.correctOptionIndex;\r\n\r\n  const response = await QuestionResponse.findOneAndUpdate(\r\n    { attemptId, questionId },\r\n    {\r\n      sectionId: sectionId,\r\n      selectedOptionIndex,\r\n      isCorrect,\r\n      $inc: { timeSpentSeconds }\r\n    },\r\n    { new: true, upsert: true }\r\n  );\r\n\r\n  return response;\r\n}\r\n\r\nexport async function finalizeAttempt(input: FinalSubmitInput) {\r\n  await connectToDatabase();\r\n\r\n  const { attemptId, mode } = input;\r\n\r\n  const attempt = await TestAttempt.findById(attemptId);\r\n  if (!attempt) {\r\n    throw new Error(\"Attempt not found\");\r\n  }\r\n\r\n  if (attempt.status !== \"in_progress\") {\r\n    return attempt;\r\n  }\r\n\r\n  const submittedAt = new Date();\r\n  const durationSeconds = Math.max(\r\n    0,\r\n    Math.round((submittedAt.getTime() - attempt.startedAt.getTime()) / 1000)\r\n  );\r\n\r\n  attempt.status = mode === \"auto\" ? \"auto_submitted\" : \"submitted\";\r\n  attempt.submittedAt = submittedAt;\r\n  attempt.durationSeconds = durationSeconds;\r\n  await attempt.save();\r\n\r\n  const analytics = await computeAttemptAnalytics(attempt._id.toString());\r\n  const ranking = await computeRankAndPercentile(\r\n    attempt.testTemplateId.toString(),\r\n    attempt._id.toString()\r\n  );\r\n\r\n  return { attempt, analytics, ranking };\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 818, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/lib/actions/tests.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { redirect } from \"next/navigation\";\r\nimport { cookies } from \"next/headers\";\r\nimport {\r\n  finalSubmitSchema,\r\n  startTestSchema,\r\n  submitAnswerSchema\r\n} from \"../validation/testSchemas\";\r\nimport { startAttempt, recordAnswer, finalizeAttempt } from \"../services/testService\";\r\nimport { connectToDatabase } from \"../db/connection\";\r\nimport { TestAttempt } from \"../db/models/TestAttempt\";\r\nimport { QuestionResponse } from \"../db/models/QuestionResponse\";\r\nimport { Question } from \"../db/models/Question\";\r\nimport { TestTemplate } from \"../db/models/TestTemplate\";\r\n\r\nasync function getCurrentUserId() {\r\n  const cookieStore = await cookies();\r\n  const existing = cookieStore.get(\"demo_user_id\")?.value;\r\n  if (existing) return existing;\r\n\r\n  const generated = \"demo-user\";\r\n  cookieStore.set(\"demo_user_id\", generated, {\r\n    path: \"/\",\r\n    maxAge: 60 * 60 * 24 * 365\r\n  });\r\n  return generated;\r\n}\r\n\r\nexport async function startTestAction(formData: FormData) {\r\n  const userId = await getCurrentUserId();\r\n  const raw = {\r\n    testTemplateId: formData.get(\"testTemplateId\"),\r\n    userId\r\n  };\r\n  const parsed = startTestSchema.parse(raw);\r\n  const result = await startAttempt(parsed);\r\n  redirect(`/attempts/${result.attempt._id.toString()}`);\r\n}\r\n\r\nexport async function submitAnswerAction(input: {\r\n  attemptId: string;\r\n  questionId: string;\r\n  sectionId: string;\r\n  selectedOptionIndex: number | null;\r\n  timeSpentSeconds: number;\r\n}) {\r\n  const parsed = submitAnswerSchema.parse(input);\r\n  await recordAnswer(parsed);\r\n}\r\n\r\nexport async function finalSubmitAction(input: {\r\n  attemptId: string;\r\n  mode?: \"manual\" | \"auto\";\r\n}) {\r\n  const parsed = finalSubmitSchema.parse({\r\n    attemptId: input.attemptId,\r\n    mode: input.mode ?? \"manual\"\r\n  });\r\n  const result = await finalizeAttempt(parsed);\r\n  if (\"attempt\" in result) {\r\n    redirect(`/attempts/${result.attempt._id.toString()}/result`);\r\n  } else {\r\n    redirect(`/attempts/${result._id.toString()}/result`);\r\n  }\r\n}\r\n\r\nexport async function getTestAttemptView(attemptId: string) {\r\n  await connectToDatabase();\r\n\r\n  const attempt = await TestAttempt.findById(attemptId).lean();\r\n  if (!attempt) {\r\n    throw new Error(\"Attempt not found\");\r\n  }\r\n\r\n  const template = await TestTemplate.findById(attempt.testTemplateId).lean();\r\n  const responses = await QuestionResponse.find({ attemptId: attempt._id }).lean();\r\n\r\n  const questions = await Question.find({\r\n    _id: { $in: responses.map((r) => r.questionId) }\r\n  }).lean();\r\n\r\n  const questionsById = new Map(\r\n    questions.map((q) => [q._id.toString(), q])\r\n  );\r\n\r\n  const items = responses.map((r) => {\r\n    const q = questionsById.get(r.questionId.toString());\r\n    if (!q) {\r\n      throw new Error(\"Question not found for response\");\r\n    }\r\n    return {\r\n      questionId: q._id.toString(),\r\n      sectionId: q.sectionId.toString(),\r\n      text: q.text,\r\n      options: q.options.map((opt: any) => ({\r\n        label: opt.label,\r\n        value: opt.value\r\n      })),\r\n      selectedOptionIndex: r.selectedOptionIndex\r\n    };\r\n  });\r\n\r\n  return {\r\n    attempt: {\r\n      id: attempt._id.toString(),\r\n      status: attempt.status,\r\n      startedAt: attempt.startedAt.toISOString(),\r\n      submittedAt: attempt.submittedAt?.toISOString() ?? null\r\n    },\r\n    template: template\r\n      ? {\r\n        id: template._id.toString(),\r\n        name: template.name,\r\n        durationMinutes: template.durationMinutes\r\n      }\r\n      : null,\r\n    items\r\n  };\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 952, "column": 0}, "map": {"version":3,"sources":["file:///C:/Vishal%20Singh/Practice%20Project/PlaceIT/.next-internal/server/app/tests/%5BtestTemplateId%5D/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getTestAttemptView as '4016ca7b6c5a15f74c7ad50c7e46c2b73f87ea06bb'} from 'ACTIONS_MODULE0'\nexport {startTestAction as '406b029178078a03f9ba4cc7f97d3352d92faf68b5'} from 'ACTIONS_MODULE0'\nexport {finalSubmitAction as '407f30009c3382cc7b728afcc4313cd00ad7eb03ca'} from 'ACTIONS_MODULE0'\nexport {submitAnswerAction as '40f0e3f9bc904b095a1a58608754399438ddc308a9'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}